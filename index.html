<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Velkovix GPA & CGPA Manager</title>

<!-- PWA Manifest -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2563eb">

<style>
body {
    font-family: Arial, sans-serif;
    margin: 0;
    background: #f7f9fc;
    color: #333;
}

nav {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    background: linear-gradient(90deg, #3b82f6, #2563eb);
    color: white;
    text-align: center;
    padding: 15px;
    font-size: 20px;
    font-weight: bold;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    z-index: 1000;
}

h1, h2 {
    text-align: center;
}

main {
    padding: 90px 20px 20px 20px;
    max-width: 1000px;
    margin: auto;
}

button {
    padding: 8px 14px;
    margin: 5px;
    background: #3b82f6;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    transition: background 0.2s ease;
}
button:hover {
    background: #2563eb;
}

input, select {
    padding: 6px;
    margin: 5px;
    border: 1px solid #ccc;
    border-radius: 6px;
}

table {
    border-collapse: collapse;
    width: 100%;
    margin-top: 10px;
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

th, td {
    border-bottom: 1px solid #eee;
    padding: 10px;
    text-align: center;
}

th {
    background: #f4f6fa;
    font-weight: bold;
}

.delete-btn {
    cursor: pointer;
    color: red;
    font-weight: bold;
    transition: color 0.2s;
}
.delete-btn:hover {
    color: darkred;
}

.semester {
    border: 2px solid #e5e7eb;
    padding: 15px;
    margin-bottom: 20px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}

.semester-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    margin-bottom: 10px;
}

.hidden {
    display: none;
}

#authScreen {
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

#authScreen input {
    width: 80%;
    margin: 10px auto;
}

#authScreen button {
    margin-top: 10px;
    width: 85%;
}
</style>
<link rel="icon" type="image/png" href="icons/icon-512.png">
<link rel="shortcut icon" href="icons/logo.png">
<link rel="icon" href="favicon.ico" type="image/x-icon">
</head>
<body>

<nav>Velkovix GPA & CGPA Manager</nav>
<main id="app" class="hidden">
    <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
        <button onclick="addSemester()">‚ûï Add Semester</button>
        <a href="quick.html" style="text-decoration:none; background:#10b981; color:white; padding:8px 14px; border-radius:6px; font-weight:bold;">
         Use Credit Hours and Grade Points
        </a>
    </div>
    <div id="semesters"></div>
    <h2>üìä Overall CGPA: <span id="overallCgpa">0.00</span></h2>
</main>

<div id="authScreen" style="padding:20px; max-width:400px; margin:120px auto; text-align:center;">
    <h1>üîê Secure Access</h1>
    <div id="setupPassword" class="hidden">
        <p>Set your new password:</p>
        <input type="password" id="newPass" placeholder="Enter password"><br>
        <button onclick="saveNewPassword()">Save Password</button>
    </div>
    <div id="loginPassword" class="hidden">
        <p>Enter your password:</p>
        <input type="password" id="loginPass" placeholder="Enter password"><br>
        <button onclick="login()">Login</button>
    </div>
</div>

<!-- CryptoJS for encryption -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>

<script>
let semesters = [];
let passwordKey = "";
let passwordHash = localStorage.getItem("velkovixPassHash");

function sha256(msg) {
    return CryptoJS.SHA256(msg).toString();
}

// ----- Authentication -----
function showAuthScreen() {
    document.getElementById("authScreen").classList.remove("hidden");
    if (!passwordHash) {
        document.getElementById("setupPassword").classList.remove("hidden");
    } else {
        document.getElementById("loginPassword").classList.remove("hidden");
    }
}

function saveNewPassword() {
    let pass = document.getElementById("newPass").value;
    if (pass.length < 4) return alert("Password must be at least 4 characters");
    passwordKey = pass;
    passwordHash = sha256(pass);
    localStorage.setItem("velkovixPassHash", passwordHash);
    semesters = [];
    saveData();
    unlockApp();
}

function login() {
    let pass = document.getElementById("loginPass").value;
    if (sha256(pass) !== passwordHash) {
        alert("Wrong password!");
        return;
    }
    passwordKey = pass;
    loadData();
    unlockApp();
}

function unlockApp() {
    document.getElementById("authScreen").classList.add("hidden");
    document.getElementById("app").classList.remove("hidden");
    renderSemesters();
}

// ----- Data Encryption -----
function saveData() {
    let encrypted = CryptoJS.AES.encrypt(JSON.stringify(semesters), passwordKey).toString();
    localStorage.setItem("velkovixData", encrypted);
}

function loadData() {
    let encrypted = localStorage.getItem("velkovixData");
    if (!encrypted) return;
    try {
        let decrypted = CryptoJS.AES.decrypt(encrypted, passwordKey).toString(CryptoJS.enc.Utf8);
        semesters = JSON.parse(decrypted) || [];
    } catch (e) {
        alert("Error decrypting data. Wrong password?");
    }
}

// ----- GPA Functions -----
function gradeToPoint(grade) {
    const mapping = { "A": 4, "B+": 3.5, "B": 3, "C+": 2.5, "C": 2, "D+": 1.5, "D": 1, "F": 0 };
    return mapping[grade] || 0;
}

function calculateGPA(courses) {
    let totalCredits = 0, totalPoints = 0;
    courses.forEach(c => {
        totalCredits += c.credit;
        totalPoints += c.gradePoints;
    });
    return totalCredits > 0 ? (totalPoints / totalCredits) : 0;
}

function calculateOverallCgpa() {
    let totalCredits = 0, totalPoints = 0;
    semesters.forEach(sem => {
        sem.courses.forEach(c => {
            totalCredits += c.credit;
            totalPoints += c.gradePoints;
        });
    });
    return totalCredits > 0 ? (totalPoints / totalCredits) : 0;
}

// ----- UI Actions -----
function addSemester() {
    semesters.push({ courses: [] });
    saveData();
    renderSemesters();
}

function deleteSemester(index) {
    if (confirm("Delete this semester?")) {
        semesters.splice(index, 1);
        saveData();
        renderSemesters();
    }
}

function addCourse(semIndex) {
    let courseName = document.getElementById(`course-${semIndex}`).value.trim();
    let credit = parseFloat(document.getElementById(`credit-${semIndex}`).value);
    let grade = document.getElementById(`grade-${semIndex}`).value;
    if (!courseName || isNaN(credit) || credit <= 0 || grade === "") {
        return alert("Please fill all fields");
    }
    let gradeValue = gradeToPoint(grade);
    let gradePoints = credit * gradeValue;
    semesters[semIndex].courses.push({ courseName, credit, grade, gradePoints });
    saveData();
    renderSemesters();
}

function deleteCourse(semIndex, courseIndex) {
    semesters[semIndex].courses.splice(courseIndex, 1);
    saveData();
    renderSemesters();
}

function renderSemesters() {
    let container = document.getElementById("semesters");
    container.innerHTML = "";

    semesters.forEach((sem, semIndex) => {
        let gpa = calculateGPA(sem.courses).toFixed(2);

        // Calculate CGPA up to this semester
        let totalCredits = 0, totalPoints = 0;
        for (let i = 0; i <= semIndex; i++) {
            semesters[i].courses.forEach(c => {
                totalCredits += c.credit;
                totalPoints += c.gradePoints;
            });
        }
        let cgpaUpToNow = totalCredits > 0 ? (totalPoints / totalCredits).toFixed(2) : "0.00";

        let semDiv = document.createElement("div");
        semDiv.className = "semester";
        semDiv.innerHTML = `
            <div class="semester-header">
                <h2 style="flex:1; text-align:center;">Semester ${semIndex + 1} ‚Äî GPA: ${gpa}, CGPA: ${cgpaUpToNow}</h2>
                <button onclick="deleteSemester(${semIndex})">üóë Delete Semester</button>
            </div>
            <div style="text-align:center;">
                <input id="course-${semIndex}" placeholder="Course Name">
                <input id="credit-${semIndex}" type="number" step="0.5" min="0" placeholder="Credit Hours">
                <select id="grade-${semIndex}">
                    <option value="">Select Grade</option>
                    <option value="A">A (4.0)</option>
                    <option value="B+">B+ (3.5)</option>
                    <option value="B">B (3.0)</option>
                    <option value="C+">C+ (2.5)</option>
                    <option value="C">C (2.0)</option>
                    <option value="D+">D+ (1.5)</option>
                    <option value="D">D (1.0)</option>
                    <option value="F">F (0.0)</option>
                </select>
                <button onclick="addCourse(${semIndex})">Add Course</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Course</th>
                        <th>Credit</th>
                        <th>Grade</th>
                        <th>Grade Points</th>
                        <th>Delete</th>
                    </tr>
                </thead>
                <tbody>
                    ${sem.courses.map((c, i) => `
                        <tr>
                            <td>${c.courseName}</td>
                            <td>${c.credit}</td>
                            <td>${c.grade}</td>
                            <td>${c.gradePoints.toFixed(2)}</td>
                            <td><span class="delete-btn" onclick="deleteCourse(${semIndex}, ${i})">X</span></td>
                        </tr>
                    `).join("")}
                </tbody>
            </table>
        `;
        container.appendChild(semDiv);
    });

    document.getElementById("overallCgpa").textContent = calculateOverallCgpa().toFixed(2);
}

// ----- Init -----
showAuthScreen();

// ----- Register Service Worker -----
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js')
    .then(() => console.log("‚úÖ Service Worker registered"))
    .catch(err => console.error("Service Worker registration failed:", err));
}
</script>
</body>
</html>
