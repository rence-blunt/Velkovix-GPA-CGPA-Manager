<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Velkovix Quick GPA & CGPA Manager</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#3b82f6">
<script>
if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("service-worker.js");
}
</script>
<style>
body {
    font-family: Arial, sans-serif;
    margin: 0;
    background: #f7f9fc;
    color: #333;
}
nav {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    background: linear-gradient(90deg, #3b82f6, #2563eb);
    color: white;
    text-align: center;
    padding: 15px;
    font-size: 20px;
    font-weight: bold;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    z-index: 1000;
}
h1, h2 {
    text-align: center;
}
main {
    padding: 90px 20px 20px 20px;
    max-width: 800px;
    margin: auto;
}
button {
    padding: 8px 14px;
    margin: 5px;
    background: #3b82f6;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    transition: background 0.2s ease;
}
button:hover {
    background: #2563eb;
}
input {
    padding: 6px;
    margin: 5px;
    border: 1px solid #ccc;
    border-radius: 6px;
}
table {
    border-collapse: collapse;
    width: 100%;
    margin-top: 10px;
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}
th, td {
    border-bottom: 1px solid #eee;
    padding: 10px;
    text-align: center;
}
th {
    background: #f4f6fa;
    font-weight: bold;
}
.delete-btn {
    cursor: pointer;
    color: red;
    font-weight: bold;
    transition: color 0.2s;
}
.delete-btn:hover {
    color: darkred;
}
.semester {
    border: 2px solid #e5e7eb;
    padding: 15px;
    margin-bottom: 20px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}
.semester-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    margin-bottom: 10px;
}
.hidden {
    display: none;
}
#authScreen {
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
#authScreen input {
    width: 80%;
    margin: 10px auto;
}
#authScreen button {
    margin-top: 10px;
    width: 85%;
}
</style>
<link rel="icon" type="image/png" href="icons/icon-512.png">
<link rel="shortcut icon" href="icons/logo.png">
<link rel="icon" href="favicon.ico" type="image/x-icon">
</head>
<body>

<nav>Velkovix Quick GPA & CGPA Manager</nav>
<main id="app" class="hidden">
    <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
        <button onclick="addSemester()">‚ûï Add Semester</button>
        <a href="index.html" style="text-decoration:none; background:#3b82f6; color:white; padding:8px 14px; border-radius:6px; font-weight:bold;">
            Back to Home
        </a>
    </div>
    <div id="semesters"></div>
    <h2>üìä Overall CGPA: <span id="overallCgpa">0.00</span></h2>
</main>

<div id="authScreen" style="padding:20px; max-width:400px; margin:120px auto; text-align:center;">
    <h1>üîê Secure Access</h1>
    <div id="loginPassword" class="hidden">
        <p>Enter your password:</p>
        <input type="password" id="loginPass" placeholder="Enter password"><br>
        <button onclick="login()">Login</button>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
<script>
let semesters = [];
let passwordKey = "";
let passwordHash = localStorage.getItem("velkovixPassHash");

// ----- Hash function -----
function sha256(msg) {
    return CryptoJS.SHA256(msg).toString();
}

// ----- Auth -----
function showAuthScreen() {
    if (!passwordHash) {
        alert("No password set. Please set it in the main app first.");
    } else {
        document.getElementById("loginPassword").classList.remove("hidden");
    }
}

function login() {
    let pass = document.getElementById("loginPass").value;
    if (sha256(pass) !== passwordHash) {
        alert("Wrong password!");
        return;
    }
    passwordKey = pass;
    loadData();
    unlockApp();
}

function unlockApp() {
    document.getElementById("authScreen").classList.add("hidden");
    document.getElementById("app").classList.remove("hidden");
    renderSemesters();
}

// ----- Data -----
function saveData() {
    let encrypted = CryptoJS.AES.encrypt(JSON.stringify(semesters), passwordKey).toString();
    localStorage.setItem("velkovixQuickData", encrypted);
}

function loadData() {
    let encrypted = localStorage.getItem("velkovixQuickData");
    if (!encrypted) return;
    try {
        let decrypted = CryptoJS.AES.decrypt(encrypted, passwordKey).toString(CryptoJS.enc.Utf8);
        semesters = JSON.parse(decrypted) || [];
    } catch (e) {
        alert("Error decrypting data.");
    }
}

// ----- GPA -----
function calculateGPA(credit, points) {
    return credit > 0 ? (points / credit) : 0;
}

function calculateOverallCgpa() {
    let totalCredits = 0, totalPoints = 0;
    semesters.forEach(sem => {
        totalCredits += sem.credit;
        totalPoints += sem.points;
    });
    return totalCredits > 0 ? (totalPoints / totalCredits) : 0;
}

function getCumulativeCgpaUpTo(index) {
    let totalCredits = 0, totalPoints = 0;
    for (let i = 0; i <= index; i++) {
        totalCredits += semesters[i].credit;
        totalPoints += semesters[i].points;
    }
    return totalCredits > 0 ? (totalPoints / totalCredits) : 0;
}

// ----- UI -----
function addSemester() {
    semesters.push({ credit: 0, points: 0 });
    saveData();
    renderSemesters();
}

function deleteSemester(index) {
    if (confirm("Delete this semester?")) {
        semesters.splice(index, 1);
        saveData();
        renderSemesters();
    }
}

function updateSemester(index) {
    let credit = parseFloat(document.getElementById(`credit-${index}`).value) || 0;
    let points = parseFloat(document.getElementById(`points-${index}`).value) || 0;
    semesters[index] = { credit, points };
    saveData();
    renderSemesters();
}

function renderSemesters() {
    let container = document.getElementById("semesters");
    container.innerHTML = "";
    semesters.forEach((sem, i) => {
        let gpa = calculateGPA(sem.credit, sem.points).toFixed(2);
        let cgpaUpToNow = getCumulativeCgpaUpTo(i).toFixed(2);
        let semDiv = document.createElement("div");
        semDiv.className = "semester";
        semDiv.innerHTML = `
            <div class="semester-header">
                <h2>Semester ${i + 1} GPA: ${gpa} | CGPA up to now: ${cgpaUpToNow}</h2>
                <button onclick="deleteSemester(${i})">üóë Delete</button>
            </div>
            <div>
                <input id="credit-${i}" type="number" step="0.5" min="0" placeholder="Total Credit Hours" value="${sem.credit}">
                <input id="points-${i}" type="number" step="0.01" min="0" placeholder="Total Grade Points" value="${sem.points}">
                <button onclick="updateSemester(${i})">Update</button>
            </div>
        `;
        container.appendChild(semDiv);
    });
    document.getElementById("overallCgpa").textContent = calculateOverallCgpa().toFixed(2);
}

// Init
showAuthScreen();

// ----- Register Service Worker -----
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js')
    .then(() => console.log("‚úÖ Service Worker registered"))
    .catch(err => console.error("Service Worker registration failed:", err));
}
</script>

</body>
</html>
